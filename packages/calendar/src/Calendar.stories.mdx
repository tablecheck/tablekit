import { Meta, Story, Canvas } from '@storybook/addon-docs/blocks';
import { action } from '@storybook/addon-actions';
import { Button } from '@tablecheck/tablekit-button';
import { Table, Tbody, Thead, Tr, Th, Td } from '@tablecheck/tablekit-table';
import {
  Months,
  Root,
  useCalendarContext,
  useMonthChange,
  useYearChange
} from './index';
import { useRef, useEffect } from 'react';
import { Spacing } from '@tablecheck/tablekit-theme';
import styled from '@emotion/styled';

<Meta
  title="Components/Calendar"
  parameters={{
    options: { isToolshown: true }
  }}
/>

export const onDateSelected = action('onDateSelected');

export const StoryRoot = (props) => (
  <Root
    {...props}
    onDateSelected={(dateObject) => onDateSelected(dateObject)}
  />
);

The `Calendar` component is a set of wrappers and utilities around the `dayzed` library.
The basic exports are;

- `Root` which must wrap everything and provides a context
- `Months` which renders the calendar grid (see Months stories for more options)
- `useMonthChange` - returns a function that can be passed the new month number (0 based) to viewed calendar
- `useYearChange` - returns a function that can be passed the new full year number to change the viewed calendar
- `useCalendarContext` - returns the context from Root including all dayzed variables and relevant settings

Though we do export the internals of the `Months` component if you want to override them it's not recommended as the internals are quite sensitive for a11y and keyboard interaction.

export function MonthSelect() {
  const handler = useMonthChange();
  const { calendars } = useCalendarContext();
  return (
    <select
      value={calendars[0].firstDayOfMonth.getMonth()}
      onChange={(event) => {
        handler(event.currentTarget.value);
      }}
    >
      <option value={0}>January</option>
      <option value={1}>February</option>
      <option value={2}>March</option>
      <option value={3}>April</option>
      <option value={4}>May</option>
      <option value={5}>June</option>
      <option value={6}>July</option>
      <option value={7}>August</option>
      <option value={8}>September</option>
      <option value={9}>October</option>
      <option value={10}>November</option>
      <option value={11}>December</option>
    </select>
  );
}

export function YearSelect() {
  const ref = useRef();
  const handler = useYearChange();
  const { calendars } = useCalendarContext();
  const currentYear = calendars[0].firstDayOfMonth.getFullYear();
  useEffect(() => {
    if (!ref.current) return;
    ref.current.value = currentYear;
  }, [currentYear]);
  return (
    <input
      ref={ref}
      defaultValue={currentYear}
      onKeyDown={(event) => {
        if (event.key === 'Enter') {
          const newValue = Number.parseInt(event.currentTarget.value, 10);
          if (!Number.isNaN(newValue)) handler(newValue);
        }
      }}
    />
  );
}

export function Next() {
  const { calendars, getForwardProps } = useCalendarContext();
  return (
    <Button {...getForwardProps({ calendars, offset: 1 })}>Next Month</Button>
  );
}

export function Prev() {
  const { calendars, getBackProps } = useCalendarContext();
  return (
    <Button {...getBackProps({ calendars, offset: 1 })}>Prev Month</Button>
  );
}

export const oneMonthLater = new Date();
oneMonthLater.setMonth(oneMonthLater.getMonth() + 1);
export const tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
export const nextWeek = new Date();
nextWeek.setDate(nextWeek.getDate() + 7);

<Canvas>
  <Story name="3 Month Range">
    <StoryRoot monthsToDisplay={3} selected={[oneMonthLater]}>
      <Prev />
      <MonthSelect />
      <YearSelect />
      <Next />
      <Months />
    </StoryRoot>
  </Story>
</Canvas>

<Canvas>
  <Story name="2 Month Range">
    <StoryRoot
      monthsToDisplay={2}
      selected={[tomorrow]}
      showOutsideDays
      minDate={new Date()}
    >
      <Prev />
      <MonthSelect />
      <YearSelect />
      <Next />
      <Months />
    </StoryRoot>
  </Story>
</Canvas>

<Canvas>
  <Story name="Range with custom month header">
    <StoryRoot selected={[tomorrow, nextWeek]} showOutsideDays>
      <div>
        <Prev />
        <MonthSelect />
        <YearSelect />
        <Next />
      </div>
      <Months
        renderMonthHeader={(calendar) =>
          `Header: ${calendar.year}-${calendar.month + 1}`
        }
        monthAriaLabel={(calendar) => `${calendar.year}-${calendar.month + 1}`}
      />
    </StoryRoot>
  </Story>
</Canvas>

export const SeparatedTable = styled(Table)`
  margin: ${Spacing.L4} 0 ${Spacing.L5};
  border: 1px solid ${({ theme }) => theme.colors.border};
`;

<Canvas>
  <Story name="Single Day with extra markup">
    <StoryRoot selected={tomorrow} minDate={new Date()} maxDate={oneMonthLater}>
      <p>
        You can add any markup you desire within the Root, in this case press
        tab and try out keyboard navigation.
      </p>
      <SeparatedTable>
        <Thead>
          <Tr>
            <Th>Key Press</Th>
            <Th>Action</Th>
          </Tr>
        </Thead>
        <Tbody>
          <Tr>
            <Td>Space / Enter</Td>
            <Td>Select current date</Td>
          </Tr>
          <Tr>
            <Td>Arrow keys</Td>
            <Td>Move to neigbouring date</Td>
          </Tr>
          <Tr>
            <Td>Home / End</Td>
            <Td>Move to first/last day of week</Td>
          </Tr>
          <Tr>
            <Td>Page-up / Page-down</Td>
            <Td>
              Move to next/previous month. Hold shift to go to next/previous
              year.
            </Td>
          </Tr>
        </Tbody>
      </SeparatedTable>
      <Months />
    </StoryRoot>
  </Story>
</Canvas>
